generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  bookings           Booking[]
  establishmentUsers EstablishmentUser[]

  @@map("users")
}

model Establishment {
  id          String   @id @default(uuid())
  name        String
  description String?
  address     String
  timezone    String   @default("UTC")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users    EstablishmentUser[]
  services Service[]
  bookings Booking[]

  @@map("establishments")
}

model EstablishmentUser {
  userId          String @map("user_id")
  establishmentId String @map("establishment_id")
  role            Role

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@id([userId, establishmentId])
  @@map("establishment_users")
}

enum Role {
  OWNER
  STAFF
}

enum ServiceType {
  SERVICE
  HOTEL
  CINEMA
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  CLEANING
  MAINTENANCE
  BLOCKED
}

model Service {
  id              String      @id @default(uuid())
  establishmentId String      @map("establishment_id")
  name            String
  description     String?
  basePrice       Decimal     @map("base_price") @db.Decimal(10, 2)
  durationMinutes Int         @map("duration_minutes")
  capacity        Int         @default(1)
  type            ServiceType @default(SERVICE)
  active          Boolean     @default(true)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  establishment  Establishment  @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  extraItems     ExtraItem[]
  availabilities Availability[]
  bookings       Booking[]
  rooms          Room[]

  @@index([establishmentId])
  @@index([type])
  @@map("services")
}

model ExtraItem {
  id          String   @id @default(uuid())
  serviceId   String   @map("service_id")
  name        String
  price       Decimal  @db.Decimal(10, 2)
  maxQuantity Int      @default(1) @map("max_quantity")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  service           Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookingExtraItems BookingExtraItem[]

  @@index([serviceId])
  @@map("extra_items")
}

model Availability {
  id        String   @id @default(uuid())
  serviceId String   @map("service_id")
  date      DateTime @db.Date
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  capacity  Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  service  Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([serviceId])
  @@index([date])
  @@map("availabilities")
}

model Room {
  id          String     @id @default(uuid())
  serviceId   String     @map("service_id")
  number      String
  floor       Int?
  description String?
  status      RoomStatus @default(AVAILABLE)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  service  Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@unique([serviceId, number])
  @@index([serviceId])
  @@index([status])
  @@map("rooms")
}

model Booking {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  establishmentId String        @map("establishment_id")
  serviceId       String        @map("service_id")
  availabilityId  String        @map("availability_id")
  quantity        Int
  totalPrice      Decimal       @map("total_price") @db.Decimal(10, 2)
  status          BookingStatus @default(PENDING)
  // Hotel-specific fields
  checkInDate     DateTime?     @map("check_in_date") @db.Date
  checkOutDate    DateTime?       @map("check_out_date") @db.Date
  roomId          String?         @map("room_id")
  numberOfNights  Int?            @map("number_of_nights")
  guestName       String?         @map("guest_name")
  guestEmail      String?         @map("guest_email")
  guestDocument   String?         @map("guest_document")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  user          User               @relation(fields: [userId], references: [id])
  establishment Establishment      @relation(fields: [establishmentId], references: [id])
  service       Service            @relation(fields: [serviceId], references: [id])
  availability  Availability       @relation(fields: [availabilityId], references: [id])
  room          Room?              @relation(fields: [roomId], references: [id], onDelete: SetNull)
  extraItems    BookingExtraItem[]

  @@index([userId])
  @@index([establishmentId])
  @@index([status])
  @@index([roomId])
  @@index([checkInDate])
  @@index([checkOutDate])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  CHECKED_IN
  CHECKED_OUT
  NO_SHOW
}

model BookingExtraItem {
  bookingId      String  @map("booking_id")
  extraItemId    String  @map("extra_item_id")
  quantity       Int
  priceAtBooking Decimal @map("price_at_booking") @db.Decimal(10, 2)

  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  extraItem ExtraItem @relation(fields: [extraItemId], references: [id])

  @@id([bookingId, extraItemId])
  @@map("booking_extra_items")
}
